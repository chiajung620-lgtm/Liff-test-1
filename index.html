<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFF 測試頁 Lite</title>
  <link rel="preconnect" href="https://static.line-scdn.net">
  <style>
    :root { --bg:#0b1220; --card:#111a2b; --muted:#93a0b3; --acc:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:#e5e7eb;font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,PingFang TC,Noto Sans CJK TC,Arial}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 10px;font-size:22px}
    p.small{margin:4px 0 12px;color:var(--muted);font-size:12px}
    .card{background:#0e1726aa;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    button{appearance:none;border:1px solid rgba(255,255,255,.14);background:#162238;color:#e5e7eb;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.primary{background:var(--acc);color:#082112;border-color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-top:12px}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px;margin-top:8px}
    .kv div{padding:8px 10px;border-radius:10px;background:#0a1322;border:1px solid rgba(255,255,255,.06)}
    .badge{display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;background:#0a1322;border:1px solid rgba(255,255,255,.06);font-size:12px}
    .ok{color:#86efac}.no{color:#fca5a5}
    .avatar{width:68px;height:68px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.14)}
    .log{white-space:pre-wrap;background:#0a1322;border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:10px;min-height:86px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0a1322;border:1px solid rgba(255,255,255,.06);padding:1px 6px;border-radius:8px}
    .copy{margin-left:8px;padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.18);font-size:12px}
    .footer{opacity:.7;font-size:12px;text-align:center;margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>LIFF 測試頁 Lite</h1>
      <p class="small">把 <code>CONFIG.LIFF_ID</code> 換成你的 LIFF ID，或在網址帶 <code>?liff=YOUR_LIFF_ID&autologin=1</code> 直接覆蓋。</p>
      <div class="toolbar" style="margin-bottom:8px">
        <button id="btnInit" class="primary">初始化</button>
        <button id="btnLogin">Login</button>
        <button id="btnLogout">Logout</button>
        <button id="btnProfile">Profile</button>
        <button id="btnFriend">Friendship</button>
        <button id="btnSend">Send Text</button>
        <button id="btnShareText">Share Text</button>
        <button id="btnShareFlex">Share Flex</button>
        <button id="btnScan">Scan QR</button>
        <button id="btnOpenInt">Open (內)</button>
        <button id="btnOpenExt">Open (外)</button>
        <button id="btnClose">Close</button>
      </div>
      <div class="grid">
        <div>
          <h3 style="margin:4px 0 6px">環境 / 狀態</h3>
          <div class="kv">
            <div>isInClient</div><div id="isInClient" class="badge">—</div>
            <div>isLoggedIn</div><div id="isLoggedIn" class="badge">—</div>
            <div>OS</div><div id="os" class="badge">—</div>
            <div>Lang</div><div id="lang" class="badge">—</div>
            <div>Version</div><div id="ver" class="badge">—</div>
            <div>Context</div><div id="ctx" class="badge">—</div>
          </div>
          <div style="margin-top:8px">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px"><span>Access Token</span><button class="copy" id="copyToken">複製</button></div>
            <div id="token" class="log"></div>
          </div>
        </div>
        <div>
          <h3 style="margin:4px 0 6px">個人資料</h3>
          <div style="display:flex;gap:10px;align-items:center">
            <img id="avatar" class="avatar" alt>
            <div>
              <div>名稱：<span id="displayName">—</span></div>
              <div>User ID：<code id="uid">—</code> <button class="copy" id="copyUid">複製</button></div>
              <div>狀態：<span id="status">—</span></div>
            </div>
          </div>
        </div>
        <div>
          <h3 style="margin:4px 0 6px">Logs</h3>
          <div id="log" class="log"></div>
          <p class="small">* shareTargetPicker / scanCodeV2 僅在支援的環境可用。</p>
        </div>
      </div>
    </div>
    <div class="footer">© 2025 LIFF Lite</div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // --- 可調整區 ---
    const CONFIG = { LIFF_ID: 'YOUR_LIFF_ID', AUTO_LOGIN: false };

    // 允許 URL 參數覆蓋
    const q = new URLSearchParams(location.search);
    const LIFF_ID = q.get('liff') || CONFIG.LIFF_ID;
    const AUTO_LOGIN = q.get('autologin') === '1' || CONFIG.AUTO_LOGIN;

    const $ = (id)=>document.getElementById(id);
    const mask=(t,k=8)=>t? t.slice(0,k)+"…"+t.slice(-k):'—';
    function log(msg,type='info'){ const t=new Date().toLocaleTimeString(); const s= typeof msg==='string'? msg: JSON.stringify(msg,null,2); $('log').textContent = `[${t}] ${type.toUpperCase()}\n`+s+"\n\n"+$('log').textContent; console[type==='error'?'error':'log'](msg); }

    function setBadge(id,ok,text){ const el=$(id); el.textContent=text ?? String(ok); el.classList.remove('ok','no'); el.classList.add(ok?'ok':'no'); }
    function refresh(){ setBadge('isInClient', liff.isInClient()); setBadge('isLoggedIn', liff.isLoggedIn()); $('os').textContent=liff.getOS?.()||'—'; $('lang').textContent=liff.getLanguage?.()||'—'; $('ver').textContent=liff.getVersion?.()||'—'; $('ctx').textContent=liff.getContext?.().type||'—'; }
    function updateToken(){ const t=liff.getAccessToken?.(); $('token').textContent = t? mask(t):'—'; }

    async function init(){
      try{
        if(!LIFF_ID || LIFF_ID==='YOUR_LIFF_ID'){ log('請先設定有效 LIFF_ID（可用 ?liff= 覆蓋）','error'); return; }
        await liff.init({ liffId: LIFF_ID });
        log({msg:'LIFF 初始化完成', liffId: LIFF_ID});
        refresh();
        if(AUTO_LOGIN && !liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return; }
        if(liff.isLoggedIn()) updateToken();
      }catch(e){ log(e,'error'); alert('初始化失敗：'+e.message); }
    }

    async function ensureLogin(){ if(!liff.isLoggedIn()){ liff.login({ redirectUri: location.href }); return false;} return true; }

    async function getProfile(){ if(!(await ensureLogin())) return; try{ const p=await liff.getProfile(); $('displayName').textContent=p.displayName||'—'; $('uid').textContent=p.userId||'—'; $('status').textContent=p.statusMessage||'—'; if(p.pictureUrl) $('avatar').src=p.pictureUrl; refresh(); updateToken(); try{ const idt=liff.getDecodedIDToken?.(); if(idt) log({idToken:{sub:idt.sub,email:idt.email}});}catch(_){} log(p);}catch(e){ log(e,'error'); alert('取得個資失敗：'+e.message);} }

    async function getFriendship(){ if(!(await ensureLogin())) return; try{ const r=await liff.getFriendship(); alert('isFriend: ' + (r.friendFlag?'是':'否')); log(r);}catch(e){ log(e,'error'); }}

    async function sendText(){ if(!liff.isInClient()){ alert('sendMessages 僅能在 LINE App 內使用'); return; } if(!(await ensureLogin())) return; try{ await liff.sendMessages([{type:'text', text:'Hello from LIFF Lite! '+new Date().toLocaleString()}]); alert('已送出 ✅'); }catch(e){ log(e,'error'); alert('送出失敗：'+e.message);} }

    async function shareText(){ const ok=liff.isApiAvailable?.('shareTargetPicker'); if(!ok){ alert('此環境不支援 shareTargetPicker'); return; } if(!(await ensureLogin())) return; try{ const res=await liff.shareTargetPicker([{ type:'text', text:'LIFF Lite：分享一段文字訊息。' }], { isMultiple:true }); log({shareTextResult:res}); }catch(e){ log(e,'error'); }}

    async function shareFlex(){ const ok=liff.isApiAvailable?.('shareTargetPicker'); if(!ok){ alert('此環境不支援 shareTargetPicker'); return; } if(!(await ensureLogin())) return; const flex={ type:'flex', altText:'LIFF Lite Flex 範例', contents:{ type:'bubble', hero:{ type:'image', url:'https://picsum.photos/600/400', size:'full', aspectRatio:'3:2', aspectMode:'cover' }, body:{ type:'box', layout:'vertical', contents:[ { type:'text', text:'LIFF Lite', weight:'bold', size:'lg' }, { type:'text', text:'這是 Flex Message 範例', color:'#aab1bd', size:'sm' } ] }, footer:{ type:'box', layout:'vertical', spacing:'sm', contents:[ { type:'button', style:'primary', action:{ type:'uri', label:'Open', uri: location.href } } ] } } };
      try{ const res=await liff.shareTargetPicker([flex]); log({shareFlexResult:res}); }catch(e){ log(e,'error'); }
    }

    async function scan(){ const ok=liff.isApiAvailable?.('scanCodeV2'); if(!ok){ alert('此環境不支援 scanCodeV2（需在 LINE App 手機）'); return; } try{ const r=await liff.scanCodeV2(); alert('QR：'+(r?.value||'—')); log(r); }catch(e){ log(e,'error'); } }

    const openInt=()=> liff.openWindow({ url: location.href, external:false });
    const openExt=()=> liff.openWindow({ url: location.href, external:true });
    const closeWin=()=> { if(liff.isInClient()) liff.closeWindow(); else alert('不在 LINE 內部視窗'); };

    // 綁定按鈕
    document.addEventListener('DOMContentLoaded',()=>{
      $('btnInit').onclick=init; $('btnLogin').onclick=()=>!liff.isLoggedIn()&&liff.login({redirectUri:location.href}); $('btnLogout').onclick=()=>{ if(liff.isLoggedIn()){ liff.logout(); location.reload(); } }; $('btnProfile').onclick=getProfile; $('btnFriend').onclick=getFriendship; $('btnSend').onclick=sendText; $('btnShareText').onclick=shareText; $('btnShareFlex').onclick=shareFlex; $('btnScan').onclick=scan; $('btnOpenInt').onclick=openInt; $('btnOpenExt').onclick=openExt; $('btnClose').onclick=closeWin; $('copyToken').onclick=()=>navigator.clipboard.writeText(liff.getAccessToken?.()||'').then(()=>alert('已複製 Token')); $('copyUid').onclick=()=>navigator.clipboard.writeText($('uid').textContent).then(()=>alert('已複製 User ID'));
    });

    // 如需開頁自動初始化：取消下一行註解
    // init();
  </script>
</body>
</html>
